<!DOCTYPE html>
<html>
<head lang="en">
  <meta charset="UTF-8">
  <link rel="stylesheet" type="text/css" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css"/>
  <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.3/leaflet.css"/>
  <!--<link rel="stylesheet" type="text/css" href="../../Leaflet/leaflet.css"/>-->
  <link rel="stylesheet" type="text/css" href="lib/leaflet.toolbar.css"/>
  <link rel="stylesheet" type="text/css" href="lib/leaflet.label.css"/>
  <link rel="stylesheet" type="text/css" href="lib/MarkerCluster.css"/>
  <link rel="stylesheet" type="text/css" href="lib/MarkerCluster.Default.css"/>
  <link rel="stylesheet" type="text/css" href="lib/L.Control.Sidebar.css"/>

  <title>Historical geocoding, visualisation and results edit</title>
  <style>
    html, body, #map {
      margin: 0;
      height: 100%;
      width: 100%;
    }
    #sidebar input[type="text"] {
      margin-top: 4px;
    }
    #sidebar input[type="button"] {
      margin-top: 12px;
    }
  </style>
</head>
<body>
<div id="map"></div>

<div id="sidebar_adress">
  <h1 id="title"> Geocoding historical adresses</h1>
  <form id="formoid" action="formoid" method="post" >
  <label for="Adresse">Adresse :</label> 
  <input type="textarea" id="user_adresse" placeholder="ex : 12 rue du temple, Paris" name="user_adresse" value="12 rue du temple, Paris" /> <br>
  <label for="Date">Date :</label>
  <input type="number" id="user_date" placeholder="ex : 1875" name="user_date" min="1800" max="2144" value="1860"/> <br>
  <label for="Date">Maximum number of results :</label>
  <input type="number" id="user_number_of_result" placeholder="ex : 4" name="user_number_of_result" min="1" max="300" value="1"/><br>
  <label for="Date">Do you want precise (house number) or rough (street, neighboourhood, city) localisation</label>
  <input type="hidden" value='0' name="user_use_precise_localisation"/> <br>
  <input type="checkbox" id="user_use_precise_localisation" name="user_use_precise_localisation" value="1" checked/> <br>
  <input id="geocodeButton" type="button" value="Geocode!" enabled/>
  </form>
</div>

<!--<div id="sidebar">
  <h1 id="title">Point of interests properties</h1>
  <input id="idTextbox" type="text" size="35" name="id" readonly="readonly"/>
  <label id="idLabel" name="id">ID</label><br>
  <input id="osmidTextbox" type="text" size="35" name="osmid" readonly="readonly"/>
  <label id="osmidLabel" name="osmid">OSM ID</label><br>
  <input id="manmadeTextbox" type="text" size="35" name="manmade"/>
  <label id="manmadeLabel" name="manmade">Man made</label><br>
  <input id="nameTextbox" type="text" size="35" name="name"/>
  <label id="nameLabel" name="name">Name</label><br>
  <input id="amenityTextbox" type="text" size="35" name="amenity"/>
  <label id="amenityLabel" name="amenity">Amenity</label><br>
  <input id="leisureTextbox" type="text" size="35" name="leisure"/>
  <label id="leisureLabel" name="leisure">Leisure</label><br>
  <input id="officeTextbox" type="text" size="35" name="office"/>
  <label id="officeLabel" name="office">Office</label><br>
  <input id="shopTextbox" type="text" size="35" name="shop"/>
  <label id="shopLabel" name="shop">Shop</label><br>
  <input id="sportTextbox" type="text" size="35" name="sport"/>
  <label id="sportLabel" name="sport">Sport</label><br>
  <input id="tourismTextbox" type="text" size="35" name="tourism"/>
  <label id="tourismLabel" name="tourism">Tourism</label><br>
  <input id="applyButton" type="button" value="Apply" enabled/>
</div>-->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
<script src="lib/spin.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.3/leaflet.js"></script>
<!--<script src="../../Leaflet/leaflet.js"></script>-->
<script src="lib/leaflet.toolbar.js"></script>
<script src="lib/leaflet.label.js"></script>
<script src="lib/leaflet.markercluster.js"></script>
<script src="editableMarkercluster/leaflet.markercluster.editablemarker.js"></script>
<script src="lib/L.Control.Sidebar.js"></script>
<script src="../dist/Leaflet-WFST.src.js"></script>
<script src="./geocoding_spinner.js"></script>
<script src="./geocoding_form.js"></script>
<script>
 // Note : spinner is an annimation that plays while loading
  var geocoding = {
    ruid: "c602fb0264056e0d6200ee85c93d6e53",
    ruid_short: function() {return String(this.ruid).substring(0,12);}
  };
  var map = L.map('map').setView([0, 0], 2);

  var disableMapInteractions = function () {
    map.dragging.disable();
    map.touchZoom.disable();
    map.doubleClickZoom.disable();
    map.scrollWheelZoom.disable();
    map.boxZoom.disable();
    map.keyboard.disable();
    if (map.tap) {
      map.tap.disable();
    }
  };

  var enableMapInteractions = function () {
    map.dragging.enable();
    map.touchZoom.enable();
    map.doubleClickZoom.enable();
    map.scrollWheelZoom.enable();
    map.boxZoom.enable();
    map.keyboard.enable();
    if (map.tap) {
      map.tap.enable();
    }
  };

  disableMapInteractions();

  var sidebar_adress = L.control.sidebar('sidebar_adress',{
    position: 'right'
  });
 
  sidebar_adress._onBtnClick = function () {
    // function called when clicking on the button of the adress sidebar
    // should send the adresse parameter to the REST API and store result
    cleaned_user_adresse = document.getElementById('user_adresse').value ;
    cleaned_user_date = parseInt(document.getElementById('user_date').value) ; 
    cleaned_user_n_results = parseInt(document.getElementById('user_number_of_result').value) ;
    cleaned_user_use_precise_localisation = document.getElementById('user_use_precise_localisation').checked ;
    var base_path = "https://www.geohistoricaldata.org/geocoding/geocoding.php"
    var dataString = encodeURI('adresse='+cleaned_user_adresse+'&date='+cleaned_user_date+'&number_of_results='+cleaned_user_n_results+'&use_precise_localisation='+cleaned_user_use_precise_localisation+'&outputForInteractiveEditing=True');

    console.log(base_path+"?"+dataString+"&callback=?");    

    test = $.ajax({
      type: "GET",
      url: base_path+"?"+dataString,//+"&callback=?",
      dataType: 'JSONP',
      success: function(data){
        alert("sucessfully wrote ruid");
        console.log(data);
        geocoding.ruid = data["ruid"];
      },
      error: function(jqXHR, textStatus, errorThrown){
        //alert("error in sending your adresse to geocoder server: "+jqXHR.toSource()+textStatus.toSource()+errorThrown.toSource());
        //console.log('jqXHR',jqXHR);
        if(jqXHR.status==201){
            // we received the expected answer, writting new ruid, loading point from server 
            console.log(jqXHR);
            //alert(JSON.parse(jqXHR.responseText)["ruid"]);
            geocoding.ruid = JSON.parse(jqXHR.responseText)[0]["ruid"];
            //alert(geocoding.ruid);
            
	    wfst = new L.WFST({
              url: 'https://www.geohistoricaldata.org/geoserver/ows',
	      typeNS: 'geocoding',
	      typeName: 'geocoding_results_v',
	      crs: L.CRS.EPSG4326,
	      geometryField: 'geom',
	      maxFeatures:100,
	      pointToLayer: function (featureData, latlng) {
                return createEditableMarker(latlng);
	      },
              filter: new L.Filter.EQ().append('ruid',geocoding.ruid_short()) 
	      });
             //alert(geocoding.ruid_short());      
	     wfst.on('load', function (e) {
			     spinner.stop();
			     enableMapInteractions();

			     markers.clearLayers();

			     e.target.eachLayer(function (layer) {
				     addWfstMarker(layer);
				     });

			     if (isFirstLoad) {
			     //map.fitBounds(markers);
			     isFirstLoad = false;
			     }

			     loadFinished = true;
			     });

	     wfst.on('save:success', function (data) {
			     spinner.stop();
			     });

	     wfst.on('save:error', function (data) {
			     spinner.stop();

			     alert('WFS-T save error occured. Take a look to console.');
			     console.error('WFS-T save error');
			     console.error(data);
			     });

          }else{
          //alert("error in sending your adresse to geocoder server: "+jqXHR+textStatus+errorThrown);
        }
        }
    });
    //alert('ruid: ' + geocoding.ruid_short() ) ; 
    return;
  };

  map.addControl(sidebar_adress) ; 
  sidebar_adress.show();
  var geocodeBtn = document.getElementById('geocodeButton')
  L.DomEvent.on(geocodeBtn, 'click', sidebar_adress._onBtnClick);


//  var sidebar = L.control.sidebar('sidebar', {
//    position: 'right'
//  });
//  map.addControl(sidebar);

L.tileLayer.wms('https://www.geohistoricaldata.org/geoserver/paris/wms', {
    layers: 'alphand_poubelle',
    //format: 'image/jpeg',
    crs: L.CRS.EPSG4326,
    //srs: 'EPSG:4326'
  }).addTo(map);

// open street map layer
//  L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', {
//    attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'
//  }).addTo(map);

  var markers = new L.MarkerClusterGroup({
    showCoverageOnHover: false,
    maxClusterRadius: 30
  }).addTo(map);

  var editModeMarkerIcon = new L.Icon({
    iconUrl: 'editableMarkercluster/images/marker-icon-red.png',
    iconRetinaUrl: 'editableMarkercluster/images/marker-icon-red-2x.png',
    iconSize: [25, 41],
    iconAnchor: [12, 40],
    popupAnchor: [1, -34],
    shadowUrl: 'editableMarkercluster/images/marker-shadow.png',
    shadowRetinaUrl: 'editableMarkercluster/images/marker-shadow.png',
    shadowSize: [41, 41],
    shadowAnchor: [12, 40]
  });

  var createEditableMarker = function (latlng, options) {
    var marker = new L.MarkerClusterGroup.EditableMarker(latlng || map.getCenter(), L.extend({
      clusterGroup: markers,
      editModeIcon: editModeMarkerIcon,
      toolbarEditIconClass: 'fa fa-lg fa-pencil-square-o',
      toolbarDeleteIconClass: 'fa fa-lg fa-trash-o',
      toolbarCloseIconClass: 'fa fa-lg fa-close',
      showLabelOnEdit: true,
      getLabelContent: function () {
        var latlng = marker.getLatLng();
        var content = 'Drag marker and click edit button again.<br>' +
          '<b>Latitude:</b> ' + latlng.lat.toFixed(6) + '<br>' +
          '<b>Longitude:</b> ' + latlng.lng.toFixed(6);

        return content;
      },
      hideToolbarAfterEdit: false
    }, options || {}));

    return marker;
  };

  var loadFinished = false;
  var isFirstLoad = true;
/*
  var wfst = new L.WFST({
    url: 'http://geoserver.ics.perm.ru/geoserver/ows',
    typeNS: 'osm_perm_region',
    typeName: 'perm_points_of_interest',
    crs: L.CRS.EPSG4326,
    geometryField: 'ogr_geometry',
    maxFeatures:5,
    pointToLayer: function (featureData, latlng) {
      return createEditableMarker(latlng);
    }
  });
 */


  var addWfstMarker = function (marker) {
    marker.on('marker:edited', function () {
      wfst.editLayer(marker);
    });

    marker.on('marker:deleted', function () {
      wfst.removeLayer(marker);
    });

    if (!markers.hasLayer(marker)) {
      markers.addLayer(marker);
    }

    if (!wfst.hasLayer(marker)) {
      wfst.addLayer(marker);
    }
  };

  new L.Toolbar.Control({
    position: 'topleft',
    actions: [
      L.ToolbarAction.extend({
        options: {
          toolbarIcon: {
            className: 'fa fa-lg fa-map-marker'
          }
        },
        addHooks: function () {
          if (!loadFinished) {
            return;
          }

          var newMarker = createEditableMarker(map.getCenter(), {
            dontShowToolbarOnFirstClick: false
          });
          newMarker.setIcon(newMarker.options.editModeIcon);

          getLabelContent = function () {
            var latlng = newMarker.getLatLng();
            var content = 'Click to finish adding.<br>' +
              '<b>Latitude:</b> ' + latlng.lat.toFixed(6) + '<br>' +
              '<b>Longitude:</b> ' + latlng.lng.toFixed(6);

            return content;
          } ; 

          var startAdding = function (e) {
            newMarker.setLatLng(e.latlng);
            map.addLayer(newMarker);

            newMarker.bindLabel(getLabelContent(), {
              noHide: true,
              direction: 'auto',
              pane: map.getPanes.popupPane
            });
            newMarker.showLabel();
          };

          var processAdding = function (e) {
            if (map.hasLayer(newMarker)) {
              newMarker.setLatLng(e.latlng);
            };

            if (newMarker.label) {
              newMarker.updateLabelContent(getLabelContent());
            }
          };

          var finishAdding = function (e) {
            map.off('mousemove', startAdding);
            map.off('mousemove', processAdding);
            map.off('click', finishAdding);
            newMarker.off('click', finishAdding);

            if (map.hasLayer(newMarker)) {
              map.removeLayer(newMarker);
            }

            if (newMarker.label) {
              newMarker.hideLabel();
              newMarker.unbindLabel();
            }

            newMarker.setIcon(newMarker.options.normalModeIcon);

            addWfstMarker(newMarker);
          };

          map.once('mousemove', startAdding);
          map.on('mousemove', processAdding);

          map.once('click', finishAdding);
          newMarker.once('click', finishAdding);
        }
      }),
      L.ToolbarAction.extend({
        options: {
          toolbarIcon: {
            className: 'fa fa-lg fa-save'
          }
        },
        addHooks: function () {
          if (!loadFinished) {
            return;
          }

          loadFinished = false;
          disableMapInteractions();
          spinner.spin(spinnerContainer);

          wfst.save();
        }
      })
    ]
  }).addTo(map);
</script>
</body>
</html>
